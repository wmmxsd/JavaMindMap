# 计算机网络

## 思维导图

![计算机网络](../../xmind/计算机网络.png)

## 五层协议

### 应用层

- 作用 进程间通信与交互的规则
- 数据传输载体 HTTP，SMTP，DNS，FTP，DNS，ICMP，SSH等等协议

### 运输层

- 作用 为应用层提供通信服务
- 数据传输载体 TCP，UDP协议

### 网络层

- 作用 为分组交换网上的不同主机提供通信服务。将运输层的报文或者用户数据报封装成IP数据包进行传输
- 数据传输载体 路由器（单位：IP数据包）

### 数据链路层

- 作用 负责网络链路上的数据传输
- 数据传输载体 交换机（单位：帧）

### 物理层

- 作用 通过物理设备传输数据
- 数据传输载体 物理设备（单位：BIT）

## TCP

### 三次握手

![TCP三次握手](../../pictures/TCP三次握手.png)

- 解释

1. `client`发送连接请求TCB，同步位`SYNC=1`，初始序号`seq=x`，进入同步`已发送状态(SYNC-SEND)`（SYN报文段规定不允许带数据，但是需要消耗一个序列号）
2. `server`收到连接请求后需要向`client`发送确认。同步位`SYNC=1`，确认位`ACK=1`，确认号为`x+1`，初始化序号`seq=y`，进入`同步已接收状态(SYNC-RECV)`（SYN-ACK报文段规定不允许带数据，但是需要消耗一个序列号）
3. `client`收到确认请求报文段后，向`server`发送确认。确认位`ACK=1`，初始序号`seq=x+1`，确认号`ack=y+1`，进入到`已建立连接状态(ESTAB-LISHED)`（报文段规定可以带数据，不带数据不消耗序列号）
4. `servier`收到确认报文段后进入到`已建立连接状态(ESTAB-LISHED)`

- 为什么需要三次握手

>为什么client还需要发送一次确认报文呢？

**是为了防止已失效的连接请求报文突然又传给`server`因而产生了错误**

&emsp;&emsp;假定一种异常情况，当`client`发送了连接请求报文后在网络中阻塞并且在TCP连接释放后到达了`server`，此时`server`发送连接确认报文段后与`client`建立连接并一直等待其发送数据。这样`server`端需要资源被浪费

### 四次挥手

![TCP释放四次挥手](../../pictures/TCP释放四次挥手.png)

- 解释

1. `clinet`发送连接释放TCB，停止发送报文，关闭TCP连接。TCB的终止控制位`FIN=1`，初始化序列号`seq=u`,进入到`终止等待1状态`（FIN报文段规定不允许带数据，但是需要消耗一个序列号）
2. `server`接收到连接释放TCB后立即发送确认，确认位`ACK=1`，初始化序列号`seq=v`，确认号`ack=u+1`，进入到`关闭等待状态`。同时通知上层应用，`client`往`server`这个方向的连接被释放
3. `client`收到确认报文后进入`终止等待2状态`。等待`server`发送连接释放报文段。
4. 若`server`已经把全部数据发送给`client`后发送连接释放报文。`FIN=1，ACK=1，seq=w，ack=u+1`，进入`最终确定状态`，等待`client`发送确认TCB（FIN报文段规定不允许带数据，但是需要消耗一个序列号）
5. `client`收到连接释放报文后发送确认报文。`ACK=1，seq=u+1，ack=w+1`，进入到`超时等待状态`，经过`2倍的超时时间`后才会关闭连接
6. `server`收到确认报文后进入关闭状态

- 为什么需要四次挥手

&emsp;&emsp;当`server`收到client发过来的释放连接的TCB时可能还有数据未发送给'client'，所以得先发一个确认报文，然后继续发送剩余数据，当所有数据发送完了之后再发送FIN报文。

- MSL（最长报文段寿命）

&emsp;&emsp;指任何报文在网络上存在的最长时间，超过这个时间报文将会被丢弃

- 为什么client在发送最终确认报文时要等待2MSL的时间？

&emsp;&emsp;**主要是为了保证ack报文能够到达目的地。** ack报文有可能丢失，那么server会重传FIN报文，A收到后再次发出ACK报文并重置计时器，最大限度保证ack报文段成功达到server。如果直接关闭连接，此时正好ack报文丢失，那么server就无法正常进入关闭状态。

## IP

### 私有地址分类

- A类地址
  - ip范围：1.0.0.1 ~ 126.255.255.255.254
  - 网络号8位，主机号24位。网络号首位为0，可用网络号`2^7-2`，因为网络号全0代表本网络，网络号除开首位全1代表环回地址，所以要减2。主机号全0代表网络地址，全1代表全部主机，所以可用主机号`2^24-2`
- B类地址
  - ip范围：128.1.0.0 ~ 191.255.255.255.254
  - 网络号16位，主机号16位。网络号前面两位固定为10，可用网络号`2^14-1`，因为128.0.0.0不指派，所以要减1。主机号全0代表网络地址，全1代表全部主机，所以可用主机号`2^16-2`
- C类地址
  - ip范围：192.0.1.1 ~ 223.255.255.255.254
  - 网络号24位，主机号8位。网络号前面三位固定为110，可用网络号`2^21-1`，因为192.0.0.0不指派，所以要减1。主机号全0代表网络地址，全1代表全部主机，所以可用主机号`2^8-2`

### 子网掩码

- 为什么需要子网掩码

    两级ip

    1. 利用率不高
    2. 路由表太大
    3. 不够灵活

- 求网络IP

    目的ip与子网掩码相与

### CIDR

- 定义 消除了传统的IP地址种类和子网划分，一个CIDR地址块代表一段网络前缀都相同的连续ip
- 写法 网络前缀/主机号（1.0.0.0/8代表1.0.0.0~1.255.255.255）
- IP范围求法

    CIDR&emsp;&nbsp;&nbsp;`1.1.1.1/16`&emsp;`= 00000001 00000001 00000001 00000001`

    最小IP&emsp;`1.1.0.0`&emsp;&emsp;&nbsp;`= 00000001 00000001 00000000 00000000`

    最大IP&emsp;`1.1.255.255`&nbsp;`= 00000001 00000001 11111111 11111111`
